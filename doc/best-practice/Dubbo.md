# 介绍

Apache Dubbo (incubating) |ˈdʌbəʊ| 是一款高性能、轻量级的开源Java RPC 框架，它提供了三大核心能力：面向接口的远程方法调用，智能容错和负载均衡，以及服务自动注册和发现。简单来说 Dubbo 是一个分布式服务框架，致力于提供高性能和透明化的RPC远程服务调用方案，以及SOA服务治理方案。

![dubbo](/img/dubbo.jpeg)

上图是RPC服务一次调用的时序图。从 Dubbo 提供的下面四点特性来说为什么要用 Dubbo：

1. **负载均衡**——同一个服务部署在不同的机器时该调用那一台机器上的服务。
2. **服务调用链路生成**——随着系统的发展，服务越来越多，服务间依赖关系变得错踪复杂，甚至分不清哪个应用要在哪个应用之前启动，架构师都不能完整的描述应用的架构关系。Dubbo 可以为我们解决服务之间互相是如何调用的。
3. **服务访问压力以及时长统计、资源调度和治理**——基于访问压力实时管理集群容量，提高集群利用率。
4. **服务降级**——某个服务挂掉之后调用备用服务。

# 最佳实践

### 非健康实例剔除

在RPC调用中，我们希望尽可能地将请求命中到那些处理能力快、处于健康状态的实例，这里的"健康"可以是我们自己定义的状态，例如错误比例到达某一个阈值时，可以认为不健康。例如某个实例的处理时间高于阈值，则也能认为其不健康。该路由的功能就是通过某种策略断定某个实例不健康，并将其排除在候选调用列表，优先调用那些健康的实例。

```java
@Reference(version = "1.0.0", parameters = {"healthCheckRoutingEnabled", "true"})
private DemoService demoService;
```

### 同区域路由

在RPC服务中，region是地区概念，如北京、上海、深圳等，不做流量分配，只做灾备。即在一个 region 不可用时，可以切换到另一个 region。region层面不做流量分配的原因：一般跨region的访问延时很高，像北京到上海有30ms。正常情况下做流量分配会对服务性能造成比较大的影响。

 在region之下还有zone的概念，zone被称作可用区，其是指在同一地域内，电力和网络互相独立的物理区域。同一可用区内实例之间的网络延时更小。在同一地域内可用区与可用区之间内网互通，可用区之间能做到故障隔离。是否将实例放在同一可用区内，主要取决于对容灾能力和网络延时的要求。

为了尽可能地提高RPC服务的效率，我们需要尽可能地将请求限制在同地区甚至是同可用区中，但是如今随着容器化的盛行以及用户部署的不可掌控性，部署的情况总是动态变化的，这就需要我们有动态获知当前实例的运行环境的能力，以感知同区域中的所有服务实例，从而做到优先调用。

但始终命中同区域中的情况，未必往往是好的。这可能会带来负载不均的情况出现，当同区域的下游实例的处理水平无法匹配到上游的请求流量时，死板的同区域路由方案会将流量始终限制在同区域中，从而打垮下游服务，并且级联影响到整个系统，此时的同区域路由效果甚至比跨区域的效果还要差，所以这就需要同区域路由有兼备服务端当前处理状态的能力，做到适时的流量转移。

```java
@Reference(version = "1.0.0", parameters = {"regionRoutingEnabled", "true"，"zoneRoutingEnabled", "true"})
private DemoService demoService;
```

### Sentinel熔断整合、限流

[Sentinel](https://github.com/alibaba/Sentinel/wiki/主页) 是面向分布式服务架构的轻量级流量控制组件，主要以流量为切入点，从限流、流量整形、熔断降级、系统负载保护等多个维度来帮助您保障微服务的稳定性。所以通过Sentinel可以极高的提高服务可用性。在某个服务可能过多地占用资源，我们需要可配置方式地进行限制某个服务的调用数，并且在服务发生故障时，不级联影响到其他核心功能的正常使用，对这类服务进行快速失败或者是触发备用降级功能。

### 使用配置管理

参考：http://dubbo.apache.org/zh-cn/docs/user/recommend.html#fn1

#### 在Provider端尽量多配置Consumer端属性

作服务的提供方，比服务消费方更清楚服务的性能参数，如调用的超时时间、合理的重试次数等。在 Provider 端配置后，Consumer 端不配置则会使用 Provider 端的配置，即 Provider 端的配置可以作为 Consumer 的缺省值。否则，Consumer 会使用 Consumer 端的全局设置，这对于 Provider 是不可控的，并且往往是不合理的。

# 参考

https://github.com/Snailclimb/JavaGuide/blob/master/docs/system-design/data-communication/dubbo.md